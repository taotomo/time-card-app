# 基本設計書 - 勤怠管理システム

## Route, Controller

### 画面名一覧とルート設定

| 画面名称 | パス | メソッド | ルート先コントローラー | アクション | 認証必須 | 説明 |
|---------|------|---------|---------------------|-----------|---------|------|
| トップ（リダイレクト） | / | GET | - | リダイレクト | × | /loginへリダイレクト |
| **【一般ユーザー】** |
| ログイン画面 | /login | GET | - | View表示 | × | ログインフォーム画面 |
| ログイン処理 | /login | POST | (Fortify) | Login | × | Fortify自動処理 |
| 新規登録画面 | /register | GET | - | View表示 | × | 会員登録フォーム画面 |
| 新規登録処理 | /register | POST | (Fortify) | Register | × | Fortify自動処理 |
| メール認証画面 | /email/verify | GET | - | View表示 | ○ | メール認証通知ページ |
| 勤怠打刻画面 | /attendance | GET | StaffController | attendance | ○ | 出退勤・休憩打刻ページ |
| 出勤打刻 | /attendance/clock-in | POST | StaffController | clockIn | ○ | 出勤時刻を記録 |
| 退勤打刻 | /attendance/clock-out | POST | StaffController | clockOut | ○ | 退勤時刻を記録 |
| 休憩開始 | /attendance/break-start | POST | StaffController | breakStart | ○ | 休憩開始時刻を記録 |
| 休憩終了 | /attendance/break-end | POST | StaffController | breakEnd | ○ | 休憩終了時刻を記録 |
| 勤怠一覧画面 | /attendance/list | GET | StaffController | attendanceList | ○ | 月次勤怠一覧ページ |
| 勤怠詳細画面 | /attendance/detail/{id} | GET | StaffController | attendanceDetail | ○ | 勤怠詳細・編集ページ |
| 勤怠更新（修正申請） | /attendance/detail/{id} | PUT | StaffController | updateAttendance | ○ | 勤怠修正申請を送信 |
| 申請一覧画面 | /requests | GET | StaffController | requestsList | ○ | 修正申請一覧ページ |
| **【管理者】** |
| 管理者ログイン画面 | /admin/login | GET | - | View表示 | × | 管理者ログインフォーム |
| 管理者ログイン処理 | /admin/login | POST | (Fortify) | Login | × | Fortify自動処理 |
| 勤怠一覧画面 | /admin/attendance/list | GET | AttendanceController | index | ○ | 日付別勤怠一覧ページ |
| 日付別詳細画面 | /admin/attendance/{id} | GET | AttendanceController | detail | ○ | 勤怠詳細編集ページ |
| 勤怠更新 | /admin/attendance/{id} | PUT | AttendanceController | update | ○ | 勤怠情報を更新 |
| スタッフ別勤怠画面 | /admin/attendance/staff/{id} | GET | AttendanceController | staffDetail | ○ | スタッフ別月次勤怠ページ |
| CSV出力 | /admin/attendance/staff/{id}/csv | GET | AttendanceController | exportCsv | ○ | 月次勤怠CSVダウンロード |
| スタッフ一覧画面 | /admin/staff/list | GET | StaffController | index | ○ | スタッフ一覧ページ |
| 申請一覧画面 | /admin/requests | GET | AttendanceController | requestsList | ○ | 修正申請一覧ページ |
| 申請詳細画面 | /admin/request/{id} | GET | AttendanceController | requestDetail | ○ | 申請詳細ページ |
| 申請承認処理 | /admin/request/{id}/approve | PUT | AttendanceController | approveRequest | ○ | 修正申請を承認 |
| **【共通】** |
| ログアウト | /logout | POST | (Fortify) | Logout | ○ | Fortify自動処理 |

---

## Model

### モデルファイル一覧

| モデルファイル名 | 説明 |
|----------------|------|
| User | ユーザー情報を管理（管理者・一般ユーザー共通） |
| Attendance | 勤怠記録を管理 |

### User モデル詳細

**ファイルパス**: `app/Models/User.php`

**主要メソッド・リレーション**:
```php
// リレーション
public function attendances(): HasMany
// ユーザーの全勤怠記録を取得

// アクセサ（必要に応じて追加可能）
// public function isAdmin(): bool
// 管理者判定（email === 'admin@example.com'）
```

**使用箇所**:
- 認証処理（Fortify）
- ユーザー一覧表示
- 勤怠記録との紐付け

---

### Attendance モデル詳細

**ファイルパス**: `app/Models/Attendance.php`

**主要メソッド・リレーション**:
```php
// リレーション
public function user(): BelongsTo
// 勤怠記録の所有ユーザーを取得

// キャスト
protected $casts = [
    'break_times' => 'array',  // JSON → 配列に自動変換
    'clock_in' => 'datetime',
    'clock_out' => 'datetime',
];
```

**使用箇所**:
- 勤怠打刻処理
- 勤怠一覧・詳細表示
- 修正申請処理
- CSV出力

---

## バリデーション

### バリデーションファイル一覧

| バリデーションファイル名 | フォーム | ルール |
|---------------------|---------|--------|
| StaffAttendanceUpdateRequest.php | 勤怠修正申請 | 詳細は下記参照 |

---

### StaffAttendanceUpdateRequest.php（勤怠修正申請）

**ファイルパス**: `app/Http/Requests/StaffAttendanceUpdateRequest.php`

| フィールド名 | ルール | エラーメッセージ |
|------------|--------|----------------|
| clock_in | 入力必須、時刻形式（H:i） | 出勤時刻を入力してください |
| clock_out | 入力必須、時刻形式（H:i） | 退勤時刻を入力してください |
| break_times.*.start | 時刻形式（H:i）、nullable | 休憩開始時刻の形式が正しくありません |
| break_times.*.end | 時刻形式（H:i）、nullable | 休憩終了時刻の形式が正しくありません |
| remarks | 入力必須 | 備考を記入してください |

**カスタムバリデーション**:
```php
// withValidator() メソッドで追加の検証
1. 出勤時刻 >= 退勤時刻の場合
   → 「出勤時間もしくは退勤時間が不適切な値です」

2. 休憩開始 < 出勤時刻 または 休憩開始 > 退勤時刻の場合
   → 「休憩時間が不適切な値です」

3. 休憩終了 > 退勤時刻の場合
   → 「休憩時間もしくは退勤時間が不適切な値です」
```

**使用箇所**:
- `/attendance/detail/{id}` (PUT) - 一般ユーザーの勤怠修正申請

---

## 補足：Fortify認証について

Laravel Fortifyが以下の認証機能を自動提供しています：

| 機能 | ルート | 説明 |
|------|--------|------|
| ログイン | POST /login | メールアドレス・パスワードで認証 |
| ログアウト | POST /logout | セッション破棄 |
| 新規登録 | POST /register | ユーザー作成 |
| メール認証 | GET /email/verify/{id}/{hash} | メール認証リンク |
| メール再送信 | POST /email/verification-notification | 認証メール再送 |

これらは `routes/web.php` で明示的に定義されていませんが、Fortifyが自動的にルートを登録しています。

---

## コントローラー一覧

### StaffController.php
**パス**: `app/Http/Controllers/StaffController.php`

**担当機能**:
- 一般ユーザーの勤怠打刻処理
- 勤怠一覧・詳細表示
- 修正申請機能
- 管理者用スタッフ一覧表示

**主要メソッド**:
- `attendance()` - 勤怠打刻画面表示
- `clockIn()` - 出勤打刻
- `clockOut()` - 退勤打刻
- `breakStart()` - 休憩開始
- `breakEnd()` - 休憩終了
- `attendanceList()` - 勤怠一覧表示
- `attendanceDetail()` - 勤怠詳細表示
- `updateAttendance()` - 勤怠修正申請
- `requestsList()` - 申請一覧表示
- `index()` - スタッフ一覧表示（管理者用）

---

### AttendanceController.php
**パス**: `app/Http/Controllers/AttendanceController.php`

**担当機能**:
- 管理者の勤怠管理機能
- 日付別・スタッフ別勤怠表示
- 修正申請承認機能
- CSV出力

**主要メソッド**:
- `index()` - 日付別勤怠一覧
- `detail()` - 日付別勤怠詳細
- `update()` - 勤怠情報更新
- `staffDetail()` - スタッフ別月次勤怠
- `exportCsv()` - CSV出力
- `requestsList()` - 申請一覧表示
- `requestDetail()` - 申請詳細表示
- `approveRequest()` - 申請承認処理

---

## ミドルウェア

| ミドルウェア | 適用範囲 | 説明 |
|------------|---------|------|
| guest | /login, /register, /admin/login | 未認証ユーザーのみアクセス可 |
| auth | 一般ユーザー・管理者の全機能 | 認証済みユーザーのみアクセス可 |
| verified | 一般ユーザーの全機能 | メール認証済みユーザーのみアクセス可 |

---

## 備考

- 管理者と一般ユーザーは同じ `users` テーブルで管理
- 管理者判定: `email === 'admin@example.com'`
- 修正申請のステータス管理: `approval_status` (0: 通常, 1: 承認待ち, 2: 承認済み)
- 休憩時間はJSON形式で複数記録可能
